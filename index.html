<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ForgeVerse ‚Äì A Pixel Economy on Solana</title>
  <meta name="description" content="ForgeVerse ‚Äì Pixel economy on Solana. Stake, Forge and Trade to grow your NFT empire."/>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet"/>

  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css?v=12"/>
</head>

<body id="top">
  <!-- ===== HEADER ===== -->
  <header class="header" role="banner">
    <div class="container header__inner">
      <a class="brand" href="#top" aria-label="ForgeVerse Home">
        <span class="brand__name neon-glow neon-glow-animated">ForgeVerse</span>
      </a>

      <nav class="nav" role="navigation" aria-label="Main">
        <a href="#about">About</a>
        <a href="#mint">Mint</a>
        <a href="#nfts">NFTs</a>
        <a href="#stake">Stake</a>
        <a href="#fusion">Fusion</a>
        <a href="#game">Game</a>
        <a href="#ranking">Ranking</a>
        <a href="#merch">Merch</a>
        <a href="#chat">Chat</a>
      </nav>

      <button id="connectBtn" class="btn btn--wallet" aria-label="Connect Phantom Wallet">Install Phantom</button>
    </div>
  </header>

  <!-- ===== HERO ===== -->
  <section class="hero">
    <div class="container hero__inner">
      <h1 class="title neon-glow-animated">A Pixel Economy on Solana</h1>
      <p class="subtitle">Stake, Forge &amp; Trade to grow your NFT empire.</p>
      <div class="hero__cta">
        <a href="#mint" class="btn btn--primary">Mint your NFT</a>
        <a href="#about" class="btn btn--secondary">Read Docs</a>
      </div>
    </div>
  </section>

  <!-- ===== ABOUT / DOCS VIEWER ===== -->
  <section id="about" class="section" aria-labelledby="about-title">
    <div class="container">
      <h2 id="about-title" class="section__title">About</h2>
      <p class="section__text">
        ForgeVerse connects NFTs, gaming, and a resource-driven economy. Each NFT has a role:
        <strong>Traders</strong> earn $DOLLAR, <strong>Farmers</strong> grow $FOOD, and
        <strong>Workers</strong> mine $METAL. Use resources to feed, forge, and fuse your NFTs.
      </p>

      <!-- Docs Buttons -->
      <div id="fv-docs-cards" class="cards" role="tablist" aria-label="Documents">
        <button data-doc="whitepaper" class="fv-card" role="tab" aria-controls="fv-docs-viewer">Whitepaper</button>
        <button data-doc="pitchdeck"  class="fv-card" role="tab" aria-controls="fv-docs-viewer">Pitchdeck</button>
        <button data-doc="roadmap"    class="fv-card" role="tab" aria-controls="fv-docs-viewer">Roadmap</button>
      </div>

      <!-- Collapsible PDF Viewer -->
      <div id="fv-docs-viewer" class="fv-viewer" role="region" aria-live="polite" aria-label="Document viewer">
        <button id="fv-close-btn" class="fv-close" aria-label="Close document">‚úï CLOSE</button>
        <iframe id="fv-docs-frame" src="" width="100%" height="820" loading="lazy" title="ForgeVerse Document Viewer"></iframe>
      </div>
    </div>
  </section>

  <!-- ===== MINT ===== -->
  <section id="mint" class="section" aria-labelledby="mint-title">
    <div class="container">
      <h2 id="mint-title" class="section__title">Mint your NFT</h2>
      <p class="section__text">Choose your role and mint. (Demo modal until live Candy Machine is connected.)</p>
      <button id="openMintModal" class="btn btn--primary">Mint (Demo)</button>
    </div>
  </section>

  <!-- ===== PLACEHOLDERS ===== -->
  <section id="nfts" class="section"><div class="container"><h2 class="section__title">Your NFTs</h2><p class="section__text">Your owned NFTs will appear here after wallet connect.</p></div></section>
  <section id="stake" class="section"><div class="container"><h2 class="section__title">Stake your NFTs</h2><p class="section__text">Stake NFTs and earn $FOOD, $METAL or $DOLLAR.</p></div></section>
  <section id="fusion" class="section"><div class="container"><h2 class="section__title">Fusion Lab</h2><p class="section__text">Fuse two NFTs using resources to obtain a stronger NFT.</p></div></section>

  <!-- ===== GAME ‚Äì PIXEL PAC ===== -->
  <section id="game" class="section" aria-labelledby="game-title">
    <div class="container">
      <h2 id="game-title" class="section__title">Game ‚Äì Pixel Pac</h2>
      <p class="section__text">
        Collect all pellets, avoid ghosts. Use <strong>Arrow Keys</strong> or <strong>WASD</strong>.
      </p>

      <div class="game-wrap">
        <div class="game-hud">
          <div class="hud-group"><span class="hud-label">Score</span><span id="pmScore" class="hud-val">0</span></div>
          <div class="hud-group"><span class="hud-label">Lives</span><span id="pmLives" class="hud-val">3</span></div>
          <div class="hud-actions">
            <button id="pmStart" class="btn btn--primary">Start</button>
            <button id="pmReset" class="btn btn--secondary">Reset</button>
          </div>
        </div>

        <div class="game-stage">
          <canvas id="pmCanvas" width="448" height="496" aria-label="Pac-Man Mini Game"></canvas>
          <div id="pmOverlay" class="game-overlay" role="status" aria-live="polite"></div>
        </div>

        <p class="game-hint">Tip: Power pellets (‚óè) let you eat ghosts for a few seconds.</p>
      </div>
    </div>
  </section>

  <!-- ===== MORE PLACEHOLDERS ===== -->
  <section id="ranking" class="section"><div class="container"><h2 class="section__title">Ranking</h2><p class="section__text">Leaderboard for top players &amp; collectors.</p></div></section>
  <section id="merch" class="section"><div class="container"><h2 class="section__title">Merch Store</h2><p class="section__text">Exclusive ForgeVerse gear with NFT-holder discounts.</p></div></section>

  <!-- ===== CHAT (Minnit) ===== -->
  <section id="chat" class="section" aria-labelledby="chat-title">
    <div class="container">
      <h2 id="chat-title" class="section__title">Community Chat</h2>
      <p class="section__text">Chat with ForgeVerse players in real time. Share tips, strategies and creations.</p>

      <button id="chatToggleBtn" class="btn btn--ghost-cyan" aria-expanded="false" aria-controls="chatPanel">
        <span id="chatToggleLabel">‚ñ∏ Open Chat</span>
        <span id="chatUsers" class="chat-users">Online: 12</span>
      </button>

      <div id="chatPanel" class="chat-panel" role="region" aria-label="ForgeVerse Chat">
        <div class="chat-container">
          <script src="https://minnit.chat/js/embed.js?c=1758971289" defer></script>
          <span
            class="minnit-chat-sembed"
            data-chatname="https://organizations.minnit.chat/363196062352045/c/Main?embed"
            data-style="width:100%; height:500px; max-height:90vh;"
            data-version="1.55"
          >Chat</span>

          <div class="chat-actions">
            <button id="chatCloseBtn" class="btn btn--close-orange">‚úï Close Chat</button>
            <p class="powered-by-minnit">
              <a href="https://minnit.chat" target="_blank" rel="noreferrer">Powered by Minnit Chat</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== FOOTER ===== -->
  <footer class="footer" role="contentinfo">
    <div class="container">
      <div class="footer__grid">
        <div>
          <div class="brand brand--footer">
            <div class="brand__box">FV</div>
            <span class="brand__name neon-glow">ForgeVerse</span>
          </div>
          <p class="muted">A Pixel Economy on Solana</p>
          <div class="socials">
            <a aria-label="Twitter" href="#" target="_blank" rel="noreferrer">Twitter</a>
            <a aria-label="Telegram" href="#" target="_blank" rel="noreferrer">Telegram</a>
            <a aria-label="GitHub" href="#" target="_blank" rel="noreferrer">GitHub</a>
            <a aria-label="Discord" href="#" target="_blank" rel="noreferrer">Discord</a>
          </div>
        </div>
        <div>
          <h3 class="footer__title">Quick Links</h3>
          <ul class="footer__list">
            <li><a href="#about">About</a></li>
            <li><a href="#mint">Mint NFT</a></li>
            <li><a href="#stake">Stake</a></li>
            <li><a href="#fusion">Fusion Lab</a></li>
          </ul>
        </div>
        <div>
          <h3 class="footer__title">Community</h3>
          <ul class="footer__list">
            <li><a href="#game">Game</a></li>
            <li><a href="#ranking">Ranking</a></li>
            <li><a href="#merch">Merch</a></li>
            <li><a href="#chat">Chat</a></li>
          </ul>
        </div>
        <div>
          <h3 class="footer__title">Legal</h3>
          <ul class="footer__list">
            <li><a href="#">Terms of Service</a></li>
            <li><a href="#">Privacy Policy</a></li>
            <li><a href="#about">Whitepaper</a></li>
            <li><a href="#">FAQ</a></li>
          </ul>
        </div>
      </div>
      <div class="divider"></div>
      <div class="copyright">
        <p class="neon-glow">¬© 2025 ForgeVerse Labs</p>
        <p>Built on Solana ‚Ä¢ Powered by the Community</p>
      </div>
    </div>
  </footer>

  <!-- ===== SCRIPTS ===== -->

  <!-- Docs Viewer (open/close with animation) -->
  <script>
    (function(){
      // TODO: ersetze durch deine finalen /preview-Links:
      const DOCS = {
        whitepaper: "https://drive.google.com/file/d/1QGnx0QtJHX5SH0qMnDksHnqTYU9S6U5o/preview",
        pitchdeck:  "https://drive.google.com/file/d/1GAAIlu69a2IzVHh3-MJVKySi_-tdMGGG/preview",
        roadmap:    "https://drive.google.com/file/d/1BZcNeluxr7n2-KBxQb-LPPeFNgrI-IkU/preview"
      };

      const cards  = document.querySelectorAll('#fv-docs-cards .fv-card');
      const viewer = document.getElementById('fv-docs-viewer');
      const frame  = document.getElementById('fv-docs-frame');
      const close  = document.getElementById('fv-close-btn');

      function openDoc(url){
        if(frame.src === url && viewer.classList.contains('show')) { closeViewer(); return; }
        frame.src = url;
        viewer.classList.add('show');
        const top = viewer.getBoundingClientRect().top + window.pageYOffset - 90;
        window.scrollTo({ top, behavior: 'smooth' });
      }
      function closeViewer(){
        viewer.classList.remove('show');
        setTimeout(()=>{ frame.src = ''; }, 450);
      }

      cards.forEach(btn => btn.addEventListener('click', () => openDoc(DOCS[btn.dataset.doc])));
      close.addEventListener('click', closeViewer);
    })();
  </script>

  <!-- Chat Toggle -->
  <script>
    (function(){
      const btn    = document.getElementById('chatToggleBtn');
      const label  = document.getElementById('chatToggleLabel');
      const panel  = document.getElementById('chatPanel');
      const close  = document.getElementById('chatCloseBtn');
      const users  = document.getElementById('chatUsers');

      panel.classList.remove('show'); panel.style.maxHeight='0px'; panel.style.opacity='0';
      btn.setAttribute('aria-expanded','false'); label.textContent='‚ñ∏ Open Chat';

      function updateUsers(){ const n = 10 + Math.floor(Math.random()*15); users.textContent = 'Online: ' + n; }
      setInterval(updateUsers, 8000);

      function openChat(){
        panel.classList.add('show');
        panel.style.maxHeight = panel.scrollHeight + 'px';
        panel.style.opacity   = '1';
        btn.setAttribute('aria-expanded','true');
        label.textContent = '‚ñæ Close Chat';
        const top = panel.getBoundingClientRect().top + window.pageYOffset - 90;
        window.scrollTo({ top, behavior:'smooth' });
      }
      function closeChat(){
        panel.style.maxHeight = panel.scrollHeight + 'px';
        requestAnimationFrame(()=>{
          panel.classList.remove('show');
          panel.style.maxHeight = '0px';
          panel.style.opacity   = '0';
        });
        btn.setAttribute('aria-expanded','false');
        label.textContent = '‚ñ∏ Open Chat';
      }

      btn.addEventListener('click', ()=> (btn.getAttribute('aria-expanded')==='true') ? closeChat() : openChat());
      close.addEventListener('click', (e)=>{ e.preventDefault(); closeChat(); });
      window.addEventListener('resize', ()=>{ if (btn.getAttribute('aria-expanded') === 'true') panel.style.maxHeight = panel.scrollHeight + 'px'; });
    })();
  </script>

  <!-- Mint Modal (Demo) -->
  <div id="mintModal" class="modal" aria-hidden="true" aria-labelledby="mintModalTitle" role="dialog">
    <div class="modal__backdrop" data-close="true"></div>
    <div class="modal__content" role="document">
      <button class="modal__close" aria-label="Close mint modal" data-close="true">‚úï</button>
      <h3 id="mintModalTitle" class="modal__title">Mint ForgeVerse NFT</h3>
      <p class="modal__subtitle">Pick your role, set quantity, confirm &amp; mint.</p>
      <form id="mintForm" class="mint-form" autocomplete="off">
        <div class="mint-row">
          <label class="mint-label">Role</label>
          <div class="mint-options">
            <label class="opt"><input type="radio" name="role" value="Trader" checked> Trader ($DOLLAR)</label>
            <label class="opt"><input type="radio" name="role" value="Farmer"> Farmer ($FOOD)</label>
            <label class="opt"><input type="radio" name="role" value="Worker"> Worker ($METAL)</label>
          </div>
        </div>
        <div class="mint-row">
          <label for="mintQty" class="mint-label">Quantity</label>
          <input id="mintQty" class="mint-input" type="number" min="1" max="10" step="1" value="1" />
        </div>
        <div class="mint-row">
          <label class="mint-label">Network</label>
          <div class="mint-chip">Solana (Demo)</div>
        </div>
        <div class="mint-summary">
          <div class="sum-line"><span>Price per mint</span><strong id="priceEach">0.10 SOL</strong></div>
          <div class="sum-line"><span>Quantity</span><strong id="qtyView">1</strong></div>
          <div class="sum-line total"><span>Total</span><strong id="totalView">0.10 SOL</strong></div>
        </div>
        <label class="terms">
          <input type="checkbox" id="acceptTerms"/>
          I accept that this is a demo mint (no on-chain transaction).
        </label>
        <div class="mint-actions">
          <button type="button" id="mintNowBtn" class="btn btn--primary" disabled>Mint Now</button>
          <button type="button" class="btn btn--secondary" data-close="true">Cancel</button>
        </div>
      </form>
      <div id="mintStatus" class="mint-status" aria-live="polite"></div>
    </div>
  </div>

  <script>
  (function(){
    const OPEN  = document.getElementById('openMintModal');
    const MODAL = document.getElementById('mintModal');
    const CLOSES= MODAL.querySelectorAll('[data-close]');
    const QTY   = document.getElementById('mintQty');
    const PRICE_EACH = 0.10;
    const priceEachEl= document.getElementById('priceEach');
    const qtyViewEl  = document.getElementById('qtyView');
    const totalViewEl= document.getElementById('totalView');
    const TERMS      = document.getElementById('acceptTerms');
    const BTN_MINT   = document.getElementById('mintNowBtn');
    const STATUS     = document.getElementById('mintStatus');

    priceEachEl.textContent = PRICE_EACH.toFixed(2) + ' SOL';
    function updateTotals(){
      const q = Math.min(10, Math.max(1, parseInt(QTY.value||'1',10)));
      QTY.value = q; qtyViewEl.textContent = q;
      totalViewEl.textContent = (q * PRICE_EACH).toFixed(2) + ' SOL';
      BTN_MINT.disabled = !TERMS.checked;
    }
    updateTotals(); QTY.addEventListener('input', updateTotals); TERMS.addEventListener('change', updateTotals);

    function openModal(){ MODAL.classList.add('show'); MODAL.setAttribute('aria-hidden','false'); STATUS.textContent=''; }
    function closeModal(){ MODAL.classList.remove('show'); MODAL.setAttribute('aria-hidden','true'); }

    OPEN.addEventListener('click', openModal);
    CLOSES.forEach(el => el.addEventListener('click', closeModal));
    MODAL.addEventListener('click', (e)=>{ if (e.target && e.target.dataset && e.target.dataset.close === 'true') closeModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && MODAL.classList.contains('show')) closeModal(); });

    BTN_MINT.addEventListener('click', async ()=>{
      if (BTN_MINT.disabled) return;
      BTN_MINT.disabled = true;
      STATUS.textContent = 'Connecting wallet...';
      const provider = window.solana || (window.phantom && window.phantom.solana) || null;
      await new Promise(r=>setTimeout(r, 700));
      STATUS.textContent = (provider && provider.isPhantom) ? 'Wallet connected.\nMinting...' : 'No Phantom detected. Proceeding in demo mode...\nMinting...';
      await new Promise(r=>setTimeout(r, 1000));
      const qty = parseInt(QTY.value||'1',10);
      const role = (document.querySelector('input[name="role"]:checked')||{value:'Trader'}).value;
      const fakeHash = '0x' + Math.random().toString(16).slice(2,10) + Math.random().toString(16).slice(2,10);
      STATUS.innerHTML = '‚úÖ Mint successful (demo)\nRole: ' + role + ' | Qty: ' + qty + '\nTx: <code style="font-size:14px;">' + fakeHash + '</code>';
      BTN_MINT.disabled = false;
    });
  })();
  </script>

  <!-- Phantom Wallet Connect (Header Button) -->
  <script>
    (function () {
      const btn = document.getElementById('connectBtn');
      if (!btn) return;

      const provider = window.solana || (window.phantom && window.phantom.solana) || null;

      function setInstall() {
        btn.textContent = 'Install Phantom';
        btn.onclick = () => window.open('https://phantom.app/', '_blank');
      }

      if (!provider || !provider.isPhantom) { setInstall(); return; }
      btn.textContent = 'Connect Wallet';

      btn.addEventListener('click', async () => {
        try {
          const resp = await provider.connect({ onlyIfTrusted: false });
          const pk = resp.publicKey.toString();
          const short = pk.slice(0,4) + '...' + pk.slice(-4);
          btn.textContent = 'Connected: ' + short;
          btn.disabled = true;
          btn.classList.add('btn--connected');
        } catch {
          alert('Wallet-Verbindung abgebrochen.');
        }
      });

      if (provider.on) {
        provider.on('connect', (pk) => {
          const s = pk.toString();
          const short = s.slice(0,4) + '...' + s.slice(-4);
          btn.textContent = 'Connected: ' + short;
          btn.disabled = true;
          btn.classList.add('btn--connected');
        });
        provider.on('disconnect', () => {
          btn.textContent = 'Connect Wallet';
          btn.disabled = false;
          btn.classList.remove('btn--connected');
        });
      }
    })();
  </script>

  <!-- ===== GAME SCRIPT (Pixel Pac ‚Äì vereinfachte Version) ===== -->
<script>
(function(){
  const TILE = 16;
  const COLS = 28;
  const ROWS = 31;

  const COLORS = {
    bg: '#000214',
    wall: '#0cc',
    pellet: '#9df',
    power: '#FFB347',
    pac: '#FFEF00',
    ghostR: '#ff4d4d',
    ghostP: '#ff68ff',
    ghostB: '#66a3ff',
    ghostO: '#ffb347',
    eyes: '#fff',
    fright: '#2aa',
    gate: '#66FAFF'
  };

  const cv = document.getElementById('pmCanvas');
  const cx = cv.getContext('2d');
  const scoreEl = document.getElementById('pmScore');
  const livesEl = document.getElementById('pmLives');
  const startBtn = document.getElementById('pmStart');
  const resetBtn = document.getElementById('pmReset');
  const overlay = document.getElementById('pmOverlay');

  // Map: 0 = pellet, 1 = wall, 2 = empty, 3 = power, 4 = gate
  const BASE_MAP = [
    "1111111111111111111111111111",
    "1000000000110000000000000001",
    "1011110110110110110111111101",
    "1030000100000000000100000301",
    "1011110101111111100101111101",
    "1000000101000000100100000001",
    "1111100101011110100101111101",
    "2000100001000000100001000102",
    "1110101111114111111101010111",
    "1000101000000000000101000101",
    "1011101011110111110101110101",
    "1030001000000100000100000301",
    "1011101111100101111101111101",
    "1000000000100101000000000001",
    "1111111110100101011111111111",
    "2000000000100001000000000002",
    "1111111110111111011111111111",
    "1000000000000000000000000001",
    "1011111111110111111111111101",
    "1010000000030100000000000101",
    "1010111111110111111111100101",
    "1010000000000000000000100101",
    "1011111111111111111110100101",
    "1000000000000000000000100001",
    "1111111111111111111111111111"
  ];
  while (BASE_MAP.length < ROWS) BASE_MAP.push(BASE_MAP[BASE_MAP.length - 1]);

  let grid;
  let pac;
  let ghosts;
  let score = 0;
  let lives = 3;
  let pelletsLeft = 0;
  let running = false;
  let frightened = false;
  let frightTimeout = null;
  let ghostTimer = null;

  function initGrid(){
    grid = BASE_MAP.map(row => row.split('').map(c => +c));
    pelletsLeft = 0;
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        if(grid[r][c]===0 || grid[r][c]===3) pelletsLeft++;
      }
    }
  }

  function initEntities(){
    pac = { cx:14, cy:23 };
    ghosts = [
      { cx:13, cy:11, color:COLORS.ghostR, home:{cx:13,cy:11}, eyes:false },
      { cx:14, cy:11, color:COLORS.ghostP, home:{cx:14,cy:11}, eyes:false },
      { cx:13, cy:13, color:COLORS.ghostB, home:{cx:13,cy:13}, eyes:false },
      { cx:14, cy:13, color:COLORS.ghostO, home:{cx:14,cy:13}, eyes:false },
    ];
  }

  function resetGame(full=true){
    if (full){
      score = 0;
      lives = 3;
    }
    running = false;
    frightened = false;
    if (frightTimeout) clearTimeout(frightTimeout);
    if (ghostTimer) clearInterval(ghostTimer);

    initGrid();
    initEntities();
    updateHUD();
    overlay.classList.remove('show');
    overlay.textContent = '';
    draw();
  }

  function updateHUD(){
    scoreEl.textContent = score;
    livesEl.textContent = lives;
  }

  function startGame(){
    if (running) return;
    running = true;
    overlay.classList.remove('show');
    ghostTimer = setInterval(stepGhosts, 280);
  }

  function endGame(message){
    running = false;
    if (ghostTimer) clearInterval(ghostTimer);
    overlay.textContent = message;
    overlay.classList.add('show');
  }

  // --- Drawing ---
  function draw(){
    cx.fillStyle = COLORS.bg;
    cx.fillRect(0,0,cv.width,cv.height);

    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const v = grid[r][c];
        const x = c*TILE, y = r*TILE;
        if (v===1){
          cx.fillStyle = COLORS.wall;
          cx.fillRect(x,y,TILE,TILE);
          cx.fillStyle = "#001c1c";
          cx.fillRect(x+2,y+2,TILE-4,TILE-4);
        } else if (v===0){
          cx.fillStyle = COLORS.pellet;
          cx.beginPath(); cx.arc(x+TILE/2, y+TILE/2, 2, 0, Math.PI*2); cx.fill();
        } else if (v===3){
          cx.fillStyle = COLORS.power;
          cx.beginPath(); cx.arc(x+TILE/2, y+TILE/2, 5, 0, Math.PI*2); cx.fill();
        } else if (v===4){
          cx.fillStyle = COLORS.gate;
          cx.fillRect(x+2, y+TILE/2-1, TILE-4, 2);
        }
      }
    }

    // Pac
    drawPac(pac.cx, pac.cy);

    // Ghosts
    ghosts.forEach(g => drawGhost(g));
  }

  function drawPac(cxTile, cyTile){
    const x = cxTile*TILE + TILE/2;
    const y = cyTile*TILE + TILE/2;
    cx.fillStyle = COLORS.pac;
    cx.beginPath();
    cx.arc(x, y, TILE*0.45, 0, Math.PI*2);
    cx.fill();
  }

  function drawGhost(g){
    const x = g.cx*TILE, y = g.cy*TILE;
    const bodyColor = g.eyes ? '#99c' : (frightened ? COLORS.fright : g.color);
    const r = TILE*0.45;

    cx.fillStyle = bodyColor;
    cx.beginPath();
    cx.arc(x+TILE/2, y+TILE/2, r, Math.PI, 0);
    cx.lineTo(x+TILE*0.9, y+TILE*0.9);
    cx.lineTo(x+TILE*0.7, y+TILE*0.8);
    cx.lineTo(x+TILE*0.5, y+TILE*0.9);
    cx.lineTo(x+TILE*0.3, y+TILE*0.8);
    cx.lineTo(x+TILE*0.1, y+TILE*0.9);
    cx.closePath();
    cx.fill();

    cx.fillStyle = COLORS.eyes;
    cx.beginPath();
    cx.arc(x+TILE*0.42, y+TILE*0.46, 2.5, 0, Math.PI*2);
    cx.fill();
    cx.beginPath();
    cx.arc(x+TILE*0.58, y+TILE*0.46, 2.5, 0, Math.PI*2);
    cx.fill();
  }

  // --- Helpers ---
  function inBounds(cx,cy){
    return cx>=0 && cx<COLS && cy>=0 && cy<ROWS;
  }
  function isWall(cx,cy){
    if (!inBounds(cx,cy)) return true;
    const v = grid[cy][cx];
    return v===1 || v===4;
  }

  function movePac(dx,dy){
    if (!running) return;
    const nx = pac.cx + dx;
    const ny = pac.cy + dy;
    if (isWall(nx,ny)) return;

    // Tunnel Wrap
    let fx = nx, fy = ny;
    if (fx < 0) fx = COLS-1;
    if (fx >= COLS) fx = 0;

    pac.cx = fx;
    pac.cy = fy;

    const cell = grid[fy][fx];
    if (cell===0){
      grid[fy][fx] = 2;
      score += 10; pelletsLeft--;
    } else if (cell===3){
      grid[fy][fx] = 2;
      score += 50; pelletsLeft--;
      triggerFright();
    }

    checkCollisions();
    updateHUD();

    if (pelletsLeft <= 0){
      endGame("YOU WIN! üéâ");
    }

    draw();
  }

  function triggerFright(){
    frightened = true;
    if (frightTimeout) clearTimeout(frightTimeout);
    frightTimeout = setTimeout(()=>{ frightened = false; draw(); }, 6000);
  }

  function stepGhosts(){
    if (!running) return;

    ghosts.forEach(g=>{
      if (g.eyes){
        // Auf Heimatfeld zur√ºck
        let dx = Math.sign(g.home.cx - g.cx);
        let dy = Math.sign(g.home.cy - g.cy);
        const options = shuffle([
          {dx,dy:0},
          {dx:0,dy},
          {dx:-dx,dy:0},
          {dx:0,dy:-dy}
        ]);
        for (const o of options){
          const nx=g.cx+o.dx, ny=g.cy+o.dy;
          if (!isWall(nx,ny)){
            g.cx=nx; g.cy=ny;
            break;
          }
        }
        if (g.cx === g.home.cx && g.cy === g.home.cy){
          g.eyes=false;
        }
        return;
      }

      // normale Jagd / Flucht
      const dirs = [
        {dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}
      ];
      const valid = dirs.filter(o => !isWall(g.cx+o.dx,g.cy+o.dy));
      if (valid.length === 0) return;

      let best;
      if (!frightened){
        // in Richtung Pac-Mann
        let bestDist = Infinity;
        valid.forEach(o=>{
          const nx=g.cx+o.dx, ny=g.cy+o.dy;
          const d2 = (nx-pac.cx)*(nx-pac.cx)+(ny-pac.cy)*(ny-pac.cy);
          if (d2 < bestDist){ bestDist=d2; best=o; }
        });
      } else {
        // von Pac weg
        let bestDist = -1;
        valid.forEach(o=>{
          const nx=g.cx+o.dx, ny=g.cy+o.dy;
          const d2 = (nx-pac.cx)*(nx-pac.cx)+(ny-pac.cy)*(ny-pac.cy);
          if (d2 > bestDist){ bestDist=d2; best=o; }
        });
      }
      if (!best) best = valid[Math.floor(Math.random()*valid.length)];
      let nx = g.cx+best.dx, ny=g.cy+best.dy;

      // Tunnel wrap f√ºr Geister
      if (nx < 0) nx = COLS-1;
      if (nx >= COLS) nx = 0;

      g.cx = nx; g.cy = ny;
    });

    checkCollisions();
    draw();
  }

  function checkCollisions(){
    ghosts.forEach(g=>{
      if (g.cx===pac.cx && g.cy===pac.cy){
        if (frightened && !g.eyes){
          // Geist essen
          g.eyes = true;
          score += 200;
          updateHUD();
        } else if (!g.eyes){
          // Pac-Mann verliert Leben
          lives--;
          updateHUD();
          if (lives <= 0){
            endGame("GAME OVER");
          } else {
            // nur Positionen zur√ºcksetzen
            initEntities();
            overlay.textContent = "Life Lost";
            overlay.classList.add('show');
            setTimeout(()=>overlay.classList.remove('show'), 700);
          }
        }
      }
    });
  }

  function shuffle(arr){
    const copy = arr.slice();
    for(let i=copy.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [copy[i],copy[j]] = [copy[j],copy[i]];
    }
    return copy;
  }

  // --- Input ---
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (!running) return;
    if (k==='arrowup'||k==='w') movePac(0,-1);
    else if (k==='arrowdown'||k==='s') movePac(0,1);
    else if (k==='arrowleft'||k==='a') movePac(-1,0);
    else if (k==='arrowright'||k==='d') movePac(1,0);
  });

  // Buttons
  startBtn.addEventListener('click', ()=>{ startGame(); });
  resetBtn.addEventListener('click', ()=>{ resetGame(true); });

  // Erstinitialisierung
  resetGame(true);
})();
</script>

</body>
</html>
